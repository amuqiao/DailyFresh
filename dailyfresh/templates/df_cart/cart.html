{% extends 'base.html'%}
{% block head %}
<script>
    function cacl_total() {
        //统计商品件数
        count=$('.cart_list_td').length;
        $('.total_count em').text(count);
        $('.settlements .col03 b').text(count);

        //小计　总计
        total = 0;
        $('.cart_list_td').each(function () {
            price=parseFloat($(this).children('.col05').children('em').text());
            count=$(this).find('.num_show').val();
            total1=price*count;
            $(this).children('.col07').text(total1.toFixed(2)+'元');
            if($(this).children('.col01').children('input').prop('checked')){
                total += total1;
            }
        });
        $('.settlements .col03 em').text(total.toFixed(2));
    }

    function check_goods() {
        //在calc_total()增加if判断,当选框被选中的时候才会被计算到总价中
        $('#check_all').change(function () {
            $(':checkbox').not('#check_all').prop('checked',$(this).prop('checked'));
            cacl_total();
        });
        $(':checkbox').not('#check_all').change(function () {
            //增加功能:当取消选中商品时,取消全选,当手动全部选中商品时,自动勾中全选
            if($(':checkbox').not('#check_all').length == $(':checked').not('#check_all').length){
                $('#check_all').prop('checked',true);
            }else{
                $('#check_all').prop('checked',false);
            }
            cacl_total();
        });
    };

    function count_change() {
        //商品数量增减,仅实现页面数据修改,此时未添加至数据库
        $('.add').click(function () {
            count = parseInt($(this).next().val());
            count += 1
            kucun = $(this).parents('.col06').prevAll('.col03').children('em').text();
            if(count > kucun ){
                count = kucun;
            }
            $(this).next().val(count).blur();
            cacl_total();
        });
        $('.minus').click(function () {
            count = parseInt($(this).prev().val());
            count -= 1
            if(count<=1){
                count =1
            }
            $(this).prev().val(count).blur();
            cacl_total();
        });
        //通过直接修改文本框数值来修改商品数量
        $('.num_show').blur(function () {
            //获取文本框数值(表示商品计数)
            count = parseInt($(this).val());
            //判断库存量
            //kucun = $(this).find('.col03').children('em').text();
            //获取库存量
            kucun = $(this).parents('.col06').prevAll('.col03').children('em').text();
            //判断商品计数不能大于库存量
            if(count > kucun ){
                count = kucun;
            }
            //判断商品计数不能小于１
            if(count <= 1){
                count = 1;
            }
            //提交商品数量修改信息
            input_count = $(this);
            id = $(this).parents('.col06').prevAll('input').val();
            $.get('/cart/count_change/',{'id':id,'count':count},function (data) {
                input_count.val(data.count);
            });
            //计算页面数据
            cacl_total();
        });
    };
    $(function () {
        //统计商品　件数　小计　总价
        cacl_total();
        //添加全选功能
        check_goods();
        //添加商品数量修改功能,并实时同步到数据库
        count_change();
    });

</script>
{% endblock head%}
{%block content%}

	<div class="total_count">全部商品<em>2</em>件</div>	
	<ul class="cart_list_th clearfix">
		<li class="col01">商品名称</li>
		<li class="col02">商品单位</li>
		<li class="col03">商品价格</li>
		<li class="col04">数量</li>
		<li class="col05">小计</li>
		<li class="col06">操作</li>
	</ul>

	{% for cart in cart_list %}
	<ul class="cart_list_td clearfix">
        <input type="hidden" value="{{cart.id}}">
		<li class="col01"><input type="checkbox" checked="checked"></li>
		<li class="col02"><img src="/static/{{cart.goods.gpic}}"></li>
		<li class="col03">{{cart.goods.gtitle}}<br>库存<em>{{cart.goods.gkucun}}</em></li>
		<li class="col04">{{cart.goods.gunit}}</li>
        <li class="col05"><em>{{cart.goods.gprice}}</em>元</li>
		<li class="col06">
			<div class="num_add">
				<a href="javascript:;" class="add fl">+</a>
				<input type="text" class="num_show fl" value="{{cart.count}}">
				<a href="javascript:;" class="minus fl">-</a>	
			</div>
		</li>
        <!--小计-->
		<li class="col07"></li>
        <!--链接处放函数,传参为商品id-->
		<li class="col08"><a href="javascript:del{{cart.id}};">删除</a></li>
	</ul>
		{% empty %}
		暂无商品
	{% endfor %}


	

	<ul class="settlements">
		<li class="col01"><input type="checkbox" id="check_all" checked=""></li>
		<li class="col02">全选</li>
		<li class="col03">合计(不含运费)：<span>¥</span><em>42.60</em><br>共计<b>2</b>件商品</li>
		<li class="col04"><a href="place_order.html">去结算</a></li>
	</ul>
{% endblock content%}
